<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Release Planner ‚Äî MVP (Static)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0f172a; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .container { max-width:1100px; margin:0 auto; padding:24px; }
    h1 { margin:0 0 16px; display:flex; align-items:center; gap:10px; font-size:28px; }
    .card { background:#0b1220; border:1px solid #334155; border-radius:16px; padding:18px; }
    .row { display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width: 900px){ .row{ grid-template-columns:1fr 1fr; } }
    label { display:block; font-size:13px; color:#cbd5e1; margin-bottom:6px; }
    input, textarea, button { width:100%; box-sizing:border-box; border-radius:10px; }
    input, textarea { background:#0a0f1a; color:#e5e7eb; border:1px solid #334155; padding:10px 12px; }
    textarea { min-height:90px; resize:vertical; }
    button { background:#38bdf8; color:#0a0f1a; border:none; padding:10px 14px; font-weight:700; cursor:pointer; }
    button.secondary { background:#111827; color:#e5e7eb; border:1px solid #334155; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns:1fr; gap:14px; }
    @media (min-width: 900px){ .grid{ grid-template-columns:1fr 1fr; } }
    .event { background:#0a0f1a; border:1px solid #334155; border-radius:14px; padding:12px; }
    .muted { color:#94a3b8; font-size:12px; }
    .title { font-weight:700; }
    .spacer { height:12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéµ Smart Release Planner ‚Äî MVP</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="url">–õ–∏–Ω–∫ –∫—ä–º –ø–µ—Å–µ–Ω (Spotify/YouTube/TikTok)</label>
          <input id="url" placeholder="https://open.spotify.com/track/..." />
        </div>
        <div>
          <label for="genre">–ñ–∞–Ω—Ä</label>
          <input id="genre" placeholder="Pop / HipHop / EDM / Indie / RnB / Rock / Trap" />
        </div>
        <div>
          <label for="wstart">–ü–µ—Ä–∏–æ–¥: –û—Ç</label>
          <input type="date" id="wstart" />
        </div>
        <div>
          <label for="wend">–ü–µ—Ä–∏–æ–¥: –î–æ</label>
          <input type="date" id="wend" />
        </div>
        <div>
          <label for="followers">–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏ (–ø–æ –∏–∑–±–æ—Ä)</label>
          <input id="followers" type="number" placeholder="–Ω–∞–ø—Ä. 2500" />
        </div>
        <div>
          <label for="notes">–ó–∞–±–µ–ª–µ–∂–∫–∏ (–ø–æ –∏–∑–±–æ—Ä)</label>
          <textarea id="notes" placeholder="–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ø–ª–∞–Ω–∏—Ä–∞–Ω —Å–∏–Ω–≥—ä–ª, –∫–æ–ª–∞–±–æ—Ä–∞—Ü–∏—è, mood, BPM..."></textarea>
        </div>
        <div style="grid-column:1 / -1">
          <button id="genBtn">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø–ª–∞–Ω</button>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <div id="resultWrap" class="hidden">
      <div class="card">
        <div class="title">üìÖ –ü—Ä–µ–ø–æ—Ä—ä—á–∞–Ω–∞ –¥–∞—Ç–∞ –∑–∞ —Ä–µ–ª–∏–π–∑</div>
        <div id="recDate" style="margin-top:6px; font-size:18px; font-weight:700">‚Äî</div>
        <div id="reason" class="muted">‚Äî</div>
        <div id="windowInfo" class="muted" style="margin-top:6px">‚Äî</div>
        <div class="row" style="margin-top:14px">
          <div>
            <div class="title" style="margin-bottom:6px">–ù–∞–π-–¥–æ–±—Ä–∏ –¥–Ω–∏ –∑–∞ –ø–æ—Å—Ç–≤–∞–Ω–µ</div>
            <ul id="bestDays"></ul>
          </div>
          <div style="display:flex; gap:8px; align-items:end">
            <button class="secondary" id="csvBtn">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button class="secondary" id="icsBtn">–ï–∫—Å–ø–æ—Ä—Ç ICS</button>
          </div>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="eventsGrid" class="grid"></div>

      <div class="spacer"></div>
      <div class="card">
        <div class="title">üß† –ü—Ä–æ–º–ø—Ç –∑–∞ OpenAI (Pro –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)</div>
        <textarea id="promptOut" readonly style="margin-top:8px"></textarea>
      </div>
    </div>

    <p class="muted" style="margin-top:10px">MVP –¥–µ–º–æ: –ª–æ–∫–∞–ª–Ω–∞ –µ–≤—Ä–∏—Å—Ç–∏–∫–∞ –±–µ–∑ –≤—ä–Ω—à–Ω–∏ API. –ó–∞ —Ñ–∏–Ω–∞–ª –≤–∫–ª—é—á–∏ OpenAI + Spotify API –ø—Ä–µ–∑ Make/Bubble.</p>
  </div>

  <script>
    // ===== Utilities (vanilla) =====
    const sofiaTZ = "Europe/Sofia";
    const fmtBG = (dt)=> new Intl.DateTimeFormat("bg-BG", {dateStyle:"full", timeStyle:"short", timeZone:sofiaTZ}).format(dt);
    const addDays = (d, n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const atTime = (d, h=18, m=0)=>{ const x=new Date(d); x.setHours(h,m,0,0); return x; };

    function scoreDays(genre, followers){
      const base={1:.6,2:.8,3:.7,4:.95,5:.85,6:.4,0:.5};
      const boost={ pop:{2:.1,4:.15}, hiphop:{5:.15,6:-.1}, indie:{1:.05,2:.1,4:.1}, edm:{5:.15,6:.05}, rnb:{2:.08,4:.12}, rock:{4:.1,5:.08}, trap:{5:.12} };
      const g=(genre||"").toLowerCase(); const b=boost[g]||{};
      const size = followers>10000? .05 : followers>2000? .02 : 0;
      const out={}; Object.entries(base).forEach(([k,v])=> out[k]=v+(b[k]||0)+size);
      return out;
    }
    function enumerateDates(a,b){
      const s=new Date(a), e=new Date(b); s.setHours(0,0,0,0); e.setHours(0,0,0,0);
      const res=[]; for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) res.push(new Date(d));
      return res;
    }
    function pickBestDateInWindow({genre, followers, startDate, endDate, preferred=[
      {dow:2, hour:18, minute:0}, {dow:4, hour:18, minute:0}, {dow:5, hour:12, minute:0}
    ]}){
      const runway=7, today=new Date(), minAllowed=addDays(today, runway);
      const defStart=addDays(today, runway), defEnd=addDays(today,30);
      const wStart=startDate? new Date(startDate): defStart;
      const wEnd  =endDate?   new Date(endDate)  : defEnd;
      const from = wStart<minAllowed ? minAllowed : wStart;
      const to   = wEnd;
      if(to<from) return { dt: atTime(from,18,0), reason:"–ö–æ—Ä–∏–≥–∏—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ ‚Üí –ø—ä—Ä–≤–∏ –≤—ä–∑–º–æ–∂–µ–Ω –¥–µ–Ω —Å–ª–µ–¥ runway." };
      const scores=scoreDays(genre, followers);
      const cand=[];
      for(const d of enumerateDates(from,to)){
        for(const p of preferred){ if(d.getDay()===p.dow){ cand.push({ dt: atTime(d,p.hour,p.minute), score: scores[String(p.dow)] ?? .5 }); } }
      }
      if(cand.length){ cand.sort((a,b)=> b.score-a.score); return { dt: cand[0].dt, reason:`–ù–∞–π-–≤–∏—Å–æ–∫ —Å–∫–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ (${(cand[0].score*100).toFixed(0)}%)` }; }
      return { dt: atTime(from,18,0), reason:"–õ–∏–ø—Å–≤–∞—Ç –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏ –¥–Ω–∏ ‚Üí –∏–∑–±—Ä–∞–Ω –µ –ø—ä—Ä–≤–∏—è—Ç –¥–µ–Ω 18:00." };
    }

    function makePlan(releaseDate, genre){
      const events=[], rd=releaseDate;
      const minus=(d,h=10)=>{ const x=addDays(rd,-d); x.setHours(h,0,0,0); return x; };
      const plus =(d,h=11)=>{ const x=addDays(rd, d); x.setHours(h,0,0,0); return x; };
      const g=(genre||"").toLowerCase();
      events.push({when:minus(7,19), title:"Teaser –≤–∏–¥–µ–æ (15 —Å–µ–∫)", channel:"TikTok/IG Reels", tip:"–ñ–∞–Ω—Ä–æ–≤–∏ —Ö–∞—à—Ç–∞–≥–æ–≤–µ + hook"});
      events.push({when:minus(5,12), title:"Pre-save –∫–∞–º–ø–∞–Ω–∏—è", channel:"Link in bio", tip:"CTA –≤ —Å—Ç–æ—Ä–∏—Ç–∞ + pin –ø–æ—Å—Ç"});
      events.push({when:minus(3,19), title:"Behind-the-scenes", channel:"Stories + YouTube Shorts", tip:"–ü–æ–∫–∞–∂–∏ –ø—Ä–æ—Ü–µ—Å–∞"});
      events.push({when:minus(1,18), title:"–ö–∞—É—ä–Ω—Ç–¥–∞—É–Ω –ø–æ—Å—Ç", channel:"IG/TikTok", tip:"–ù–∞–ø–æ–º–Ω—è–Ω–µ –∑–∞ —á–∞—Å–∞"});
      events.push({when:rd,         title:"RELEASE", channel:"Spotify/YouTube", tip:"–ü—Ä–µ–º–∏–µ—Ä–∞ –≤ —Ç–æ—á–Ω–∏—è —á–∞—Å"});
      events.push({when:plus(1,12),  title:"Live Q&A", channel:"TikTok Live", tip:"–ü–æ–∫–∞–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏"});
      events.push({when:plus(3,18),  title:"Performance clip", channel:"IG Reels", tip:"30 —Å–µ–∫ hook"});
      events.push({when:plus(7,18),  title:"Collab –ø–æ—Å—Ç", channel:"–ú–∏–∫—Ä–æ–∏–Ω—Ñ–ª—É–µ–Ω—Å—ä—Ä", tip:"Duet/Collab"});
      if(["edm","trap"].includes(g)) events.push({when:plus(10,20), title:"DJ promo pack", channel:"Dropbox/Promo mail", tip:"–†–∞–¥–∏–æ/–∫–ª—É–± edit + coverart"});
      return events.sort((a,b)=> a.when-b.when);
    }

    function toCSV(events){
      const header=["–î–∞—Ç–∞","–î–µ–π–Ω–æ—Å—Ç","–ö–∞–Ω–∞–ª","–°—ä–≤–µ—Ç"].join(",");
      const rows=events.map(e=> [e.when.toISOString(), e.title, e.channel, e.tip]
        .map(x=>`"${String(x).replaceAll('"','\\"')}"`).join(",")
      );
      return [header, ...rows].join("\n");
    }

    function icsForEvents(events, projectName="Smart Release Planner"){
      const dtStamp=new Date();
      const fmt=(d)=>`${d.getUTCFullYear()}${String(d.getUTCMonth()+1).padStart(2,"0")}${String(d.getUTCDate()).padStart(2,"0")}T${String(d.getUTCHours()).padStart(2,"0")}${String(d.getUTCMinutes()).padStart(2,"0")}${String(d.getUTCSeconds()).padStart(2,"0")}Z`;
      const lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Smart Release Planner//BG"];
      events.forEach((e,i)=>{
        const start=new Date(e.when), end=new Date(start.getTime()+60*60*1000);
        lines.push("BEGIN:VEVENT",
          `UID:${i}-${dtStamp.getTime()}@smart-release`,
          `DTSTAMP:${fmt(dtStamp)}`,
          `DTSTART:${fmt(start)}`,
          `DTEND:${fmt(end)}`,
          `SUMMARY:${e.title} ‚Äî ${projectName}`,
          `DESCRIPTION:${e.channel} | ${e.tip}`,
          "END:VEVENT");
      });
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    function download(filename, text){
      const blob=new Blob([text], {type:"text/plain;charset=utf-8"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),800);
    }

    // ===== App wiring (vanilla) =====
    const $ = (id)=> document.getElementById(id);
    const resultWrap = $("resultWrap");
    const recDate = $("recDate");
    const reason = $("reason");
    const windowInfo = $("windowInfo");
    const bestDays = $("bestDays");
    const eventsGrid = $("eventsGrid");
    const promptOut = $("promptOut");

    function setDefaults(){
      const s = addDays(new Date(),7).toISOString().slice(0,10);
      const e = addDays(new Date(),30).toISOString().slice(0,10);
      $("wstart").value = s; $("wend").value = e;
    }

    function handleGenerate(){
      const url = $("url").value.trim();
      const genre = $("genre").value.trim();
      const followers = parseInt($("followers").value || "0", 10) || 0;
      const notes = $("notes").value.trim();
      const winStart = $("wstart").value;
      const winEnd = $("wend").value;

      if(!(url.length>0 || genre.length>0)){
        alert("–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –ª–∏–Ω–∫ –∏–ª–∏ –∂–∞–Ω—Ä.");
        return;
      }

      const { dt, reason: why } = pickBestDateInWindow({ genre, followers, startDate: winStart, endDate: winEnd });
      const plan = makePlan(dt, genre);

      // Fill summary
      recDate.textContent = fmtBG(dt);
      reason.textContent = `–ü—Ä–∏—á–∏–Ω–∞: ${why}`;
      windowInfo.textContent = `–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–∏–æ–¥: ${winStart} ‚Üí ${winEnd} (–∏–∑–∏—Å–∫–≤–∞–Ω–µ: ‚â• 7 –¥–Ω–∏ runway)`;

      // Best days
      bestDays.innerHTML = "";
      ["–≤—Ç–æ—Ä–Ω–∏–∫","—á–µ—Ç–≤—ä—Ä—Ç—ä–∫"].forEach(d=>{
        const li=document.createElement("li"); li.textContent=d; bestDays.appendChild(li);
      });

      // Events grid
      eventsGrid.innerHTML = "";
      plan.forEach(ev=>{
        const div=document.createElement("div");
        div.className="event";
        div.innerHTML = `
          <div class="muted">${fmtBG(ev.when)}</div>
          <div class="title" style="margin-top:6px">${ev.title}</div>
          <div class="muted" style="margin-top:4px"><b>–ö–∞–Ω–∞–ª:</b> ${ev.channel}</div>
          <div class="muted" style="margin-top:2px"><b>–°—ä–≤–µ—Ç:</b> ${ev.tip}</div>
        `;
        eventsGrid.appendChild(div);
      });

      // Prompt preview
      promptOut.value = `You are an AI music marketing strategist. Analyze engagement around this song and return JSON with recommended release date (Europe/Sofia timezone), best days to post, and plans for pre-launch, launch-day, and post-launch.\n\nSong URL: ${url || "(add URL)"}\nGenre: ${genre || "(genre)"}\nFollowers: ${followers || "(0)"}\n\nConstraints:\n- Prefer Tue/Thu/Fri; avoid weekend where appropriate.\n- Ensure ~7 days pre-launch runway.\n- Chosen window: ${winStart} ‚Üí ${winEnd}.\n- Provide rationale in one sentence.\n\nOutput JSON:\n{\n  \"recommended_date\": \"YYYY-MM-DD HH:MM\",\n  \"best_days_to_post\": [\"Tuesday\",\"Thursday\"],\n  \"pre_launch_plan\": \"...\",\n  \"launch_day_actions\": \"...\",\n  \"post_launch_plan\": \"...\",\n  \"rationale\": \"...\" \n}`;

      // Export buttons wire-up
      $("csvBtn").onclick = ()=> download("release_plan.csv", toCSV(plan));
      $("icsBtn").onclick = ()=> download("release_plan.ics", icsForEvents(plan, "Smart Release Planner"));

      resultWrap.classList.remove("hidden");
    }

    $("genBtn").addEventListener("click", handleGenerate);
    setDefaults();

    // Smoke tests to ensure no white screen
    (function runTests(){
      const csv=toCSV([{when:new Date("2025-01-02T18:00:00Z"), title:'He said "Hi"', channel:"X", tip:"Y"}]);
      console.assert(csv.includes("\n"), "CSV newline ok");
      console.assert(csv.includes('\\"'), "CSV quotes escaped");
      const ics=icsForEvents([{when:new Date("2025-01-02T18:00:00Z"), title:"A", channel:"B", tip:"C"}]);
      console.assert(ics.includes("BEGIN:VCALENDAR") && ics.includes("END:VCALENDAR"), "ICS envelope ok");
      const days=(function(a,b){const s=new Date(a),e=new Date(b);s.setHours(0,0,0,0);e.setHours(0,0,0,0);let c=0;for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1))c++;return c;})("2025-01-01","2025-01-03");
      console.assert(days===3, "enumerate includes ends");
    })();
  </script>
</body>
</html>

